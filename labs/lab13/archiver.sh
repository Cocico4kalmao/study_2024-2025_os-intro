#!/bin/bash

# –ü–æ–∫–∞–∂–µ–º –ø–æ–º–æ—â—å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
if [ "$1" = "--help" ] || [ "$1" = "-h" ] || [ $# -eq 0 ]; then
    echo "=== –ê—Ä—Ö–∏–≤–∞—Ç–æ—Ä —Ñ–∞–π–ª–æ–≤ ==="
    echo ""
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:"
    echo "  $0 –ø–∞–ø–∫–∞ –∞—Ä—Ö–∏–≤.tar.gz         - –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã"
    echo "  $0 –ø–∞–ø–∫–∞ –∞—Ä—Ö–∏–≤.tar.gz recent  - —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞ –Ω–µ–¥–µ–ª—é"
    echo ""
    echo "–ü—Ä–∏–º–µ—Ä—ã:"
    echo "  $0 /home/user/docs backup.tar.gz"
    echo "  $0 ./my_folder backup.tar.gz recent"
    echo "  $0 --help                     - –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É –ø–æ–º–æ—â—å"
    exit 0
fi

# –ü—Ä–æ–≤–µ—Ä–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
if [ $# -lt 2 ]; then
    echo "–û—à–∏–±–∫–∞: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤!"
    echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: $0 –ø–∞–ø–∫–∞ –∞—Ä—Ö–∏–≤.tar.gz"
    exit 1
fi

# –ó–∞–ø–æ–º–Ω–∏–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
FOLDER="$1"
ARCHIVE="$2"
MODE="$3"

# –ü—Ä–æ–≤–µ—Ä–∏–º —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–∞–ø–∫–∞
if [ ! -d "$FOLDER" ]; then
    echo "–û—à–∏–±–∫–∞: –ü–∞–ø–∫–∞ '$FOLDER' –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∏–º –ø—Ä–∞–≤–∞ –Ω–∞ —á—Ç–µ–Ω–∏–µ
if [ ! -r "$FOLDER" ]; then
    echo "–û—à–∏–±–∫–∞: –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —á—Ç–µ–Ω–∏–µ –ø–∞–ø–∫–∏ '$FOLDER'!"
    exit 1
fi

# –£–¥–∞–ª–∏–º —Å—Ç–∞—Ä—ã–π –∞—Ä—Ö–∏–≤ –µ—Å–ª–∏ –µ—Å—Ç—å
if [ -f "$ARCHIVE" ]; then
    echo "–£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∞—Ä—Ö–∏–≤..."
    rm "$ARCHIVE"
fi

# –í—ã–±–µ—Ä–µ–º —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
echo "=== –ù–∞—á–∏–Ω–∞–µ–º –∞—Ä—Ö–∏–≤–∞—Ü–∏—é ==="
echo "–ü–∞–ø–∫–∞: $FOLDER"
echo "–ê—Ä—Ö–∏–≤: $ARCHIVE"

if [ "$MODE" = "recent" ]; then
    echo "–†–µ–∂–∏–º: —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞ –Ω–µ–¥–µ–ª—é"
    echo ""
    
    # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è —Å–ø–∏—Å–∫–∞
    TEMP_FILE=$(mktemp)
    
    # –ò—â–µ–º —Ñ–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
    find "$FOLDER" -type f -mtime -7 > "$TEMP_FILE"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—à–ª–∏ –ª–∏ —Ñ–∞–π–ª—ã
    FILE_COUNT=$(wc -l < "$TEMP_FILE")
    if [ "$FILE_COUNT" -eq 0 ]; then
        echo "–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é!"
        rm "$TEMP_FILE"
        exit 0
    fi
    
    echo "–ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: $FILE_COUNT"
    
    # –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    if tar -czf "$ARCHIVE" -C "$FOLDER" -T <(sed "s|^$FOLDER/||" "$TEMP_FILE"); then
        echo "‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∞—Ä—Ö–∏–≤ recent —Ñ–∞–π–ª–æ–≤!"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞—Ä—Ö–∏–≤–∞!"
        rm "$TEMP_FILE"
        exit 1
    fi
    
    # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    rm "$TEMP_FILE"
    
else
    echo "–†–µ–∂–∏–º: –≤—Å–µ —Ñ–∞–π–ª—ã"
    echo ""
    
    # –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º –≤—Å—é –ø–∞–ø–∫—É
    if tar -czf "$ARCHIVE" -C "$FOLDER" .; then
        echo "‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∞—Ä—Ö–∏–≤ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤!"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞—Ä—Ö–∏–≤–∞!"
        exit 1
    fi
fi

# –ü–æ–∫–∞–∂–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∞—Ä—Ö–∏–≤–µ
echo ""
echo "=== –†–µ–∑—É–ª—å—Ç–∞—Ç ==="
echo "–ê—Ä—Ö–∏–≤: $ARCHIVE"
echo "–†–∞–∑–º–µ—Ä: $(du -h "$ARCHIVE" | cut -f1)"

# –ü–æ—Å—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ –≤ –∞—Ä—Ö–∏–≤–µ
FILE_COUNT_IN_ARCHIVE=$(tar -tzf "$ARCHIVE" | wc -l)
echo "–§–∞–π–ª–æ–≤ –≤ –∞—Ä—Ö–∏–≤–µ: $FILE_COUNT_IN_ARCHIVE"

echo ""
echo "üéâ –ê—Ä—Ö–∏–≤–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
